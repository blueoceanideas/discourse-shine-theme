<script>
document.addEventListener('DOMContentLoaded', () => {
  var pageNotFoundElem = document.querySelector('h1.page-not-found');
  if ( pageNotFoundElem ) {
    console.log("is 404, render modal");
    var page = document.querySelector("section#main");
    var footer = document.querySelector("footer.laruta-footer");
    var pageNotFoundModal = document.querySelector(".page-not-found-modal-container");

    page.classList.add("blurred");
    footer.classList.add("blurred");
    pageNotFoundModal.setAttribute("style", "display: flex;")

  } else {
    console.log("not a 404 page");
    I18n.translations.en.js.topic.create = "Create New Topic";
    I18n.translations.en.js.topic.all_topics_header = "All Topics in %{category} Community";
  }
});
</script>

<script type="text/x-handlebars" data-template-name="/connectors/before-topic-list-body/all-category-header">
  <h3 id="allTopicsHeader">All Topics in this Community</h3>
</script>

<script type="text/discourse-plugin" version="0.8">
</script>

<script type="text/x-handlebars" data-template-name="/connectors/above-site-header/laruta-super-nav">
    <div class="super-nav">
    	<div>
    		<ul class="links">
    		</ul>
    		<ul class="user-nav">
    			<li class="login" id="renewWrapper">
    				<a href="https://www.msba.org">
    				    <span class="icon-corner-up-left"></span>
                        <span>Back to MSBA.org</span>
    				</a>
    			</li>
            </ul>
        </div>
    </div>
</script>

<script type="text/discourse-plugin"  version="0.8">

// Queue up code to run after Ember does its rendering of DOM things
Ember.run.schedule('afterRender', () => {

    const larutaPages     = [ 'connect', 'how-to-use-connect' ];
    const siteLogoLink    = document.querySelector(".d-header .title a");
    const menuPanelParent = document.querySelector(".panel.clearfix");

    // Redirect Logo Link in Header to the Landing Page
    siteLogoLink.addEventListener("click", (event) => {
        redirectToLarutaPage( 'connect' );
    });

    // api.onPageChange is the closest thing to a "page refresh"
    // since Discourse is a single page web app
    api.onPageChange(() =>{
        setCategoryBoxesBackgroundColor();
        moveNavAndFiltersOnCategoryView();
    });

    // check if the render <html> is a mobile or desktop view
    // because there are some major, major, major differences
    const isMobileView = function () {
        let html = document.querySelector("html");
        return html.classList.contains( "mobile-view" );
    };

    function moveNavAndFiltersOnCategoryView () {
        const route = Discourse.__container__.lookup('controller:application').get('currentPath');

        console.log(route);

        if ( route == "discovery.parentCategory" ) {
            console.log("moveNavAndFiltersOnCategoryView");

          // Get Navigation & Filters
          let navAndFilters = [
            ".list-controls"
          ];

          // Get the Topic List
          const topicList = document.querySelector(".topic-list");

          // Get the Row to move the filtering above
          let targetRow = topicList.parentNode.parentNode.parentNode.parentNode;
          console.log(targetRow);


          navAndFilters.forEach( ( elem ) => {
            if ( !targetRow.contains( document.querySelector( elem ) ) ) {
              targetRow.insertBefore(document.querySelector( elem ), targetRow.firstChild);
            }
          } );
        }
    }

    function linkToTopicListIfFiltered () {

        // Check if the page url contains "/l/" in it,
        // and send to the topic list if it does
         if( /\/l\//.test(window.location.href) ) {
           var url = window.location.href;

           let topicListHeaderId = "#allTopicsHeader";

           if ( !url.includes(topicListHeaderId) ){
             newUrl = url + topicListHeaderId;
             window.location.replace(newUrl);
           }
         }
     }

    function setCategoryBoxesBackgroundColor () {
        // Get the Category Elements nodeList
        // then convert to an Array
        let categoriesElems = isMobileView() ? document.querySelectorAll(".category-list > .category-list-item") : document.querySelectorAll(".category-list tr");
        let categoriesArray = Array.prototype.slice.call( categoriesElems );

        // Loop through the elements to capture border color
        // then pass it to the background color
        categoriesArray.forEach( function(category) {

                // Mobile view uses a separate table for each category
                if ( isMobileView() ) {
                    let categoryColor = category.style.borderColor;

                    // set the background color
                    category.style.backgroundColor = categoryColor;
                }

                // Desktop view uses a single table and each category is a table row
                else {
                    var categoryBox   = category.querySelector(".category");
                    var categoryColor = categoryBox.style.borderColor;

                    // set the background color
                    category.style.backgroundColor = categoryColor;
                }
            }
        );
    }

    function redirectToLarutaPage( pageUrl ){
      event.preventDefault();
      if( larutaPages.includes( pageUrl ) ){
        window.location.replace( 'https://msba.demo.laruta.io/' + pageUrl );
      }
    }
} );
</script>

<div class="mobile-connect-super-nav super-nav">
    <a href="https://msba.org">
        <span class="icon-corner-up-left"></span>
        <span>Back to MSBA.org</span>
    </a>
</div>
